---
- name: Idempotent File Management
  hosts: local
  become: yes
  vars:
    app_config_dir: /etc/myapp
    app_user: appuser
    app_group: appgroup
    
  tasks:
    - name: Create application group
      group:
        name: "{{ app_group }}"
        state: present
        
    - name: Create application user
      user:
        name: "{{ app_user }}"
        group: "{{ app_group }}"
        home: /home/{{ app_user }}
        shell: /bin/bash
        state: present
        
    - name: Create application config directory
      file:
        path: "{{ app_config_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
        
    - name: Create application config file
      copy:
        content: |
          # Application Configuration
          app_name=MyApplication
          app_version=1.0.0
          debug=false
          log_level=info
        dest: "{{ app_config_dir }}/app.conf"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
        backup: yes
        
    - name: Ensure specific line exists in config
      lineinfile:
        path: "{{ app_config_dir }}/app.conf"
        line: "environment=production"
        state: present
        
    - name: Create log directory
      file:
        path: /var/log/myapp
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
