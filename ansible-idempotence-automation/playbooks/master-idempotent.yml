---
- name: Master Idempotent Configuration
  hosts: local
  become: yes
  vars:
    app_config_dir: /etc/myapp
    app_user: appuser
    app_group: appgroup
    web_root: /var/www/html
    
  tasks:
    # User and Group Management
    - name: Create application group
      group:
        name: "{{ app_group }}"
        state: present
        
    - name: Create application user
      user:
        name: "{{ app_user }}"
        group: "{{ app_group }}"
        home: /home/{{ app_user }}
        shell: /bin/bash
        state: present
        
    # Package Management
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
        
    - name: Install required packages
      apt:
        name:
          - nginx
          - git
          - curl
          - htop
          - tree
          - jq
        state: present
        
    # Directory Structure
    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
      loop:
        - "{{ app_config_dir }}"
        - /var/log/myapp
        - /opt/myapp
        
    - name: Create web root directory
      file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
        
    # Configuration Files
    - name: Create application config file
      copy:
        content: |
          # Application Configuration - Generated by Ansible
          app_name=MyApplication
          app_version=1.0.0
          debug=false
          log_level=info
          environment=production
          created_date={{ ansible_date_time.date }}
        dest: "{{ app_config_dir }}/app.conf"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
        backup: yes
        
    - name: Create systemd service file
      copy:
        content: |
          [Unit]
          Description=My Application Service
          After=network.target
          
          [Service]
          Type=simple
          User={{ app_user }}
          Group={{ app_group }}
          WorkingDirectory=/opt/myapp
          ExecStart=/bin/bash -c 'while true; do echo "Service running at $(date)" >> /var/log/myapp/service.log; sleep 60; done'
          Restart=always
          RestartSec=10
          
          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/myapp.service
        mode: '0644'
      notify:
        - reload systemd
        - restart myapp
        
    - name: Create web content
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Idempotent Configuration Demo</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  .status { background: #e8f5e8; padding: 20px; border-radius: 5px; margin: 20px 0; }
                  .info { background: #e8f4fd; padding: 15px; border-radius: 5px; margin: 10px 0; }
                  h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
                  h2 { color: #007acc; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Ansible Idempotence Demonstration</h1>
                  <div class="status">
                      <h2>Configuration Status: Complete</h2>
                      <p>This server has been configured using idempotent Ansible playbooks.</p>
                  </div>
                  <div class="info">
                      <h3>Idempotent Features Implemented:</h3>
                      <ul>
                          <li>User and group management</li>
                          <li>Package installation and removal</li>
                          <li>File and directory creation</li>
                          <li>Service configuration and management</li>
                          <li>Web server setup</li>
                      </ul>
                  </div>
                  <div class="info">
                      <h3>Test Results:</h3>
                      <p>Running this playbook multiple times will produce identical results without unwanted changes.</p>
                      <p>Generated on: {{ ansible_date_time.date }} at {{ ansible_date_time.time }}</p>
                  </div>
              </div>
          </body>
          </html>
        dest: "{{ web_root }}/index.html"
        owner: www-data
        group: www-data
        mode: '0644'
        
    # Service Management
    - name: Enable and start services
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
        daemon_reload: yes
      loop:
        - nginx
        - myapp
        
    # Verification Tasks
    - name: Verify nginx is responding
      uri:
        url: http://localhost
        method: GET
        status_code: 200
      register: web_check
      
    - name: Verify application service is running
      systemd:
        name: myapp
        state: started
      register: service_check
      
    - name: Display verification results
      debug:
        msg: 
          - "Web server status: {{ 'OK' if web_check.status == 200 else 'FAILED' }}"
          - "Application service: {{ 'Running' if service_check.status.ActiveState == 'active' else 'Not Running' }}"
          
  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
        
    - name: restart myapp
      systemd:
        name: myapp
        state: restarted
