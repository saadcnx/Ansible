---
- name: Idempotent Package Management
  hosts: local
  become: yes
  
  tasks:
    - name: Update package cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
        
    - name: Install required packages
      apt:
        name:
          - nginx
          - git
          - curl
          - htop
          - tree
        state: present
        
    - name: Remove unwanted packages
      apt:
        name:
          - apache2
          - sendmail
        state: absent
        
    - name: Ensure nginx service is enabled and started
      systemd:
        name: nginx
        enabled: yes
        state: started
        
    - name: Create nginx custom config
      copy:
        content: |
          server {
              listen 8080;
              server_name localhost;
              
              location / {
                  root /var/www/html;
                  index index.html;
              }
              
              location /health {
                  return 200 "OK";
                  add_header Content-Type text/plain;
              }
          }
        dest: /etc/nginx/sites-available/custom
        backup: yes
      notify: restart nginx
        
    - name: Enable custom nginx site
      file:
        src: /etc/nginx/sites-available/custom
        dest: /etc/nginx/sites-enabled/custom
        state: link
      notify: restart nginx
      
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted
