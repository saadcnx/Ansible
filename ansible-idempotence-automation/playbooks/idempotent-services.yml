---
- name: Idempotent Service Configuration
  hosts: local
  become: yes
  vars:
    web_root: /var/www/html
    
  tasks:
    - name: Create web content directory
      file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'
        
    - name: Create index.html file
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>Idempotent Web Server</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; }
                  .container { max-width: 800px; margin: 0 auto; }
                  .status { background: #e8f5e8; padding: 20px; border-radius: 5px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>Idempotent Ansible Configuration</h1>
                  <div class="status">
                      <h2>Server Status: Active</h2>
                      <p>This page was created using idempotent Ansible tasks.</p>
                      <p>Running multiple times produces the same result.</p>
                  </div>
              </div>
          </body>
          </html>
        dest: "{{ web_root }}/index.html"
        owner: www-data
        group: www-data
        mode: '0644'
        
    - name: Configure nginx main config
      lineinfile:
        path: /etc/nginx/nginx.conf
        regexp: '^\s*worker_processes'
        line: '        worker_processes auto;'
        backup: yes
      notify: reload nginx
      
    - name: Ensure nginx is running and enabled
      systemd:
        name: nginx
        state: started
        enabled: yes
        
    - name: Check if nginx is responding
      uri:
        url: http://localhost
        method: GET
        status_code: 200
      register: nginx_check
      retries: 3
      delay: 2
      
    - name: Display nginx status
      debug:
        msg: "Nginx is responding correctly on port 80"
      when: nginx_check.status == 200
      
  handlers:
    - name: reload nginx
      systemd:
        name: nginx
        state: reloaded
